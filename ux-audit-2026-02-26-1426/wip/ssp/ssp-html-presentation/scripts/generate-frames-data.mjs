#!/usr/bin/env node

import fs from "node:fs/promises";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const presentationDir = path.resolve(__dirname, "..");
const penPath = path.resolve(presentationDir, "..", "..", "new-design.pen");
const outputPath = path.resolve(presentationDir, "frames-data.js");

const includePrefix = [
  "App / System Security Plans /",
  "Prototype / System Security Plans /",
];

const keepKeys = new Set([
  "type",
  "id",
  "name",
  "x",
  "y",
  "width",
  "height",
  "fill",
  "stroke",
  "padding",
  "gap",
  "layout",
  "justifyContent",
  "alignItems",
  "children",
  "content",
  "fontFamily",
  "fontSize",
  "fontWeight",
  "letterSpacing",
  "textGrowth",
  "iconFontName",
  "iconFontFamily",
]);

function pruneNode(node) {
  const pruned = {};
  for (const [key, value] of Object.entries(node)) {
    if (!keepKeys.has(key)) {
      continue;
    }

    if (key === "children") {
      if (Array.isArray(value) && value.length > 0) {
        pruned.children = value.map(pruneNode);
      }
      continue;
    }

    pruned[key] = value;
  }
  return pruned;
}

function isSspFrame(node) {
  if (!node || node.type !== "frame" || typeof node.name !== "string") {
    return false;
  }

  return includePrefix.some((prefix) => node.name.startsWith(prefix));
}

async function main() {
  const raw = await fs.readFile(penPath, "utf8");
  const pen = JSON.parse(raw);

  const frames = Array.isArray(pen.children) ? pen.children.filter(isSspFrame) : [];
  const prunedFrames = frames.map(pruneNode);
  const sortedFrames = prunedFrames.sort((a, b) => a.name.localeCompare(b.name));

  const header = [
    "// Auto-generated by scripts/generate-frames-data.mjs",
    `// Source: ${path.basename(penPath)}`,
    `// Generated at: ${new Date().toISOString()}`,
    "",
  ].join("\n");

  const fileContents = `${header}export const FRAME_DATA = ${JSON.stringify(sortedFrames, null, 2)};\n`;
  await fs.writeFile(outputPath, fileContents, "utf8");

  process.stdout.write(`Wrote ${sortedFrames.length} frames to ${outputPath}\n`);
}

main().catch((error) => {
  process.stderr.write(`${error.stack || error.message}\n`);
  process.exit(1);
});
